using System;
using System.Collections.Generic;
using UnityEngine;
using FMODUnity;
using FMOD.Studio;

namespace TBaltaks.FMODManagement
{
    public class AudioManager : IDisposable
    {
        private static AudioManager _instance;
        private static readonly object _lock = new();

        public static AudioManager Instance
        {
            get
            {
                if (_instance != null) return _instance;
                lock (_lock)
                {
                    if (_instance == null)
                    {
                        _instance = new AudioManager();
                    }
                    return _instance;
                }
            }
        }

        private Dictionary<int, EventInstance> eventInstances = new();
        private Dictionary<EventDescription, Dictionary<LocalAudioParameter, PARAMETER_ID>> localParameterIDs = new();
        private Dictionary<GlobalAudioParameter, PARAMETER_ID> globalParameterIDs = new();

        private bool _isDisposed = false;


        private AudioManager()
        {
            Application.quitting += OnApplicationQuit;
#if UNITY_EDITOR
            UnityEditor.EditorApplication.playModeStateChanged += OnPlayModeStateChanged;
#endif
            CacheGlobalParameterIDs();
        }


        public void Dispose()
        {
            if (_isDisposed) return;
            _isDisposed = true;

            Application.quitting -= OnApplicationQuit;
#if UNITY_EDITOR
            UnityEditor.EditorApplication.playModeStateChanged -= OnPlayModeStateChanged;
#endif
            _instance = null;
        }


        private void OnApplicationQuit()
        {
            CleanUp(false);
            Dispose();
        }


#if UNITY_EDITOR
        private void OnPlayModeStateChanged(UnityEditor.PlayModeStateChange state)
        {
            if (state == UnityEditor.PlayModeStateChange.ExitingPlayMode)
            {
                CleanUp(false);
                Dispose();
            }
        }
#endif


        private void CleanUp(bool doesCleanUpAllowFadeOut = true)
        {
            var keys = new List<int>(eventInstances.Keys);
            foreach (int key in keys)
            {
                EventInstance eventInstance = eventInstances[key];
                FMOD.Studio.STOP_MODE stopMode = doesCleanUpAllowFadeOut
                    ? FMOD.Studio.STOP_MODE.ALLOWFADEOUT
                    : FMOD.Studio.STOP_MODE.IMMEDIATE;
                eventInstance.stop(stopMode);
                eventInstance.release();
                eventInstances.Remove(key);
            }
        }


        private void CacheLocalParameterIDs(EventDescription eventDescription)
        {
            if (localParameterIDs.ContainsKey(eventDescription)) return;

            Dictionary<LocalAudioParameter, PARAMETER_ID> idLookup = new();
            foreach (LocalAudioParameter parameter in Enum.GetValues(typeof(LocalAudioParameter)))
            {
                FMOD.RESULT result = eventDescription.getParameterDescriptionByName(parameter.ToLabel(), out PARAMETER_DESCRIPTION parameterDescription);

                if (result == FMOD.RESULT.OK)
                {
                    idLookup.Add(parameter, parameterDescription.id);
                }
            }

            localParameterIDs.Add(eventDescription, idLookup);
        }


        private void CacheGlobalParameterIDs()
        {
            foreach (GlobalAudioParameter parameter in Enum.GetValues(typeof(GlobalAudioParameter)))
            {
                RuntimeManager.StudioSystem.getParameterDescriptionByName(parameter.ToLabel(), out PARAMETER_DESCRIPTION parameterDescription);
                globalParameterIDs.Add(parameter, parameterDescription.id);
            }
        }


        private EventInstance CreateEventInstance(string eventPath)
        {
            EventInstance eventInstance = RuntimeManager.CreateInstance(eventPath);
            eventInstances.Add(eventInstance.GetHashCode(), eventInstance);
            eventInstance.getDescription(out EventDescription eventDescription);
            CacheLocalParameterIDs(eventDescription);
            return eventInstance;
        }


        public int StartNewEvent(string eventPath)
        {
            EventInstance eventInstance = CreateEventInstance(eventPath);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }

        public int StartNewEvent(string eventPath, Transform emitterTransform)
        {
            EventInstance eventInstance = CreateEventInstance(eventPath);
            RuntimeManager.AttachInstanceToGameObject(eventInstance, emitterTransform);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }

        public int StartNewEvent(string eventPath, Transform emitterTransform, Rigidbody emitterRigidbody)
        {
            EventInstance eventInstance = CreateEventInstance(eventPath);
            RuntimeManager.AttachInstanceToGameObject(eventInstance, emitterTransform, emitterRigidbody);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }

        public int StartNewEvent(string eventPath, Transform emitterTransform, Rigidbody2D emitterRigidbody)
        {
            EventInstance eventInstance = CreateEventInstance(eventPath);
            RuntimeManager.AttachInstanceToGameObject(eventInstance, emitterTransform, emitterRigidbody);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }


        public void PauseEvent(int eventInstanceID)
        {
            eventInstances[eventInstanceID].setPaused(true);
        }


        public void UnpauseEvent(int eventInstanceID)
        {
            eventInstances[eventInstanceID].setPaused(false);
        }


        public void StopEvent(int eventInstanceID, bool allowFadeOut = true)
        {
            FMOD.Studio.STOP_MODE stopMode = allowFadeOut ? FMOD.Studio.STOP_MODE.ALLOWFADEOUT : FMOD.Studio.STOP_MODE.IMMEDIATE;
            EventInstance eventInstance = eventInstances[eventInstanceID];
            eventInstance.stop(stopMode);
            eventInstance.release();
        }


        public void PlayOneShot(string eventPath)
        {
            RuntimeManager.PlayOneShot(eventPath);
        }

        public void PlayOneShot(string eventPath, Vector3 position)
        {
            RuntimeManager.PlayOneShot(eventPath, position);
        }

        public void PlayOneShot(string eventPath, GameObject emitter)
        {
            RuntimeManager.PlayOneShotAttached(eventPath, emitter);
        }


        public void SetLocalParameter(int eventInstanceID, LocalAudioParameter parameter, float value)
        {
            eventInstances[eventInstanceID].getDescription(out EventDescription eventDescription);
            if (localParameterIDs[eventDescription].TryGetValue(parameter, out PARAMETER_ID parameterID))
            {
                eventInstances[eventInstanceID].setParameterByID(parameterID, value);
            }
            else
            {
                Debug.LogWarning($"[FMOD Management] Tried to set {parameter} parameter on an event that does not contain it.");
            }
        }


        public float GetLocalParameter(int eventInstanceID, LocalAudioParameter parameter)
        {
            float value = 0;

            eventInstances[eventInstanceID].getDescription(out EventDescription eventDescription);
            if (localParameterIDs[eventDescription].TryGetValue(parameter, out PARAMETER_ID parameterID))
            {
                eventInstances[eventInstanceID].getParameterByID(parameterID, out value);
            }
            else
            {
                Debug.LogWarning($"[FMOD Management] Tried to get value for {parameter} parameter on an event that does not contain it.");
            }

            return value;
        }


        public void SetGlobalParameter(GlobalAudioParameter parameter, float value)
        {
            RuntimeManager.StudioSystem.setParameterByID(globalParameterIDs[parameter], value);
        }


        public float GetGlobalParameter(GlobalAudioParameter parameter)
        {
            RuntimeManager.StudioSystem.getParameterByID(globalParameterIDs[parameter], out float value);
            return value;
        }
    }
}