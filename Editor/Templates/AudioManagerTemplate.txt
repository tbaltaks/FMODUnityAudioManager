using System;
using System.Collections.Generic;
using UnityEngine;
using FMODUnity;
using FMOD.Studio;

namespace TBaltaks.FMODManagement
{
    public class AudioManager : MonoBehaviour
    {
        public static AudioManager Instance;
        private Dictionary<int, EventInstance> eventInstances = new();
        private Dictionary<EventDescription, Dictionary<LocalAudioParameter, PARAMETER_ID>> localParameterIDs = new();
        private Dictionary<GlobalAudioParameter, PARAMETER_ID> globalParameterIDs = new();


        private void Awake()
        {
            if (Instance != null && Instance != this)
            {
                Destroy(gameObject);
                return;
            }

            Instance = this;
            DontDestroyOnLoad(gameObject);

            CacheGlobalParameterIDs();
        }


        private void OnDisable()
        {
            CleanUp();
        }


        private void CleanUp(bool doesCleanUpAllowFadeOut = true)
        {
            var keys = new List<int>(eventInstances.Keys);
            foreach (int key in keys)
            {
                EventInstance eventInstance = eventInstances[key];
                FMOD.Studio.STOP_MODE stopMode = doesCleanUpAllowFadeOut
                    ? FMOD.Studio.STOP_MODE.ALLOWFADEOUT
                    : FMOD.Studio.STOP_MODE.IMMEDIATE;
                eventInstance.stop(stopMode);
                eventInstance.release();
                eventInstances.Remove(key);
            }
        }


        private void CacheLocalParameterIDs(EventDescription eventDescription)
        {
            if (localParameterIDs.ContainsKey(eventDescription)) return;

            Dictionary<LocalAudioParameter, PARAMETER_ID> idLookup = new();
            foreach (LocalAudioParameter parameter in Enum.GetValues(typeof(LocalAudioParameter)))
            {
                FMOD.RESULT result = eventDescription.getParameterDescriptionByName(parameter.ToString(), out PARAMETER_DESCRIPTION parameterDescription);

                if (result == FMOD.RESULT.OK)
                {
                    idLookup.Add(parameter, parameterDescription.id);
                }
            }

            localParameterIDs.Add(eventDescription, idLookup);
        }


        private void CacheGlobalParameterIDs()
        {
            foreach (GlobalAudioParameter parameter in Enum.GetValues(typeof(GlobalAudioParameter)))
            {
                RuntimeManager.StudioSystem.getParameterDescriptionByName(parameter.ToString(), out PARAMETER_DESCRIPTION parameterDescription);
                globalParameterIDs.Add(parameter, parameterDescription.id);
            }
        }


        private EventInstance CreateEventInstance(EventReference eventReference)
        {
            EventInstance eventInstance = RuntimeManager.CreateInstance(eventReference);
            eventInstances.Add(eventInstance.GetHashCode(), eventInstance);
            CacheLocalParameterIDs(RuntimeManager.GetEventDescription(eventReference));
            return eventInstance;
        }


        public int StartNewEvent(EventReference eventReference)
        {
            EventInstance eventInstance = CreateEventInstance(eventReference);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }

        public int StartNewEvent(EventReference eventReference, Transform emitterTransform)
        {
            EventInstance eventInstance = CreateEventInstance(eventReference);
            RuntimeManager.AttachInstanceToGameObject(eventInstance, emitterTransform);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }

        public int StartNewEvent(EventReference eventReference, Transform emitterTransform, Rigidbody emitterRigidbody)
        {
            EventInstance eventInstance = CreateEventInstance(eventReference);
            RuntimeManager.AttachInstanceToGameObject(eventInstance, emitterTransform, emitterRigidbody);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }

        public int StartNewEvent(EventReference eventReference, Transform emitterTransform, Rigidbody2D emitterRigidbody)
        {
            EventInstance eventInstance = CreateEventInstance(eventReference);
            RuntimeManager.AttachInstanceToGameObject(eventInstance, emitterTransform, emitterRigidbody);
            eventInstance.start();
            return eventInstance.GetHashCode();
        }


        public void PauseUnpauseEvent(int eventInstanceID, bool setPaused)
        {
            eventInstances[eventInstanceID].setPaused(setPaused);
        }


        public void StopEvent(int eventInstanceID, bool allowFadeOut = true)
        {
            FMOD.Studio.STOP_MODE stopMode = allowFadeOut ? FMOD.Studio.STOP_MODE.ALLOWFADEOUT : FMOD.Studio.STOP_MODE.IMMEDIATE;
            EventInstance eventInstance = eventInstances[eventInstanceID];
            eventInstance.stop(stopMode);
            eventInstance.release();
        }


        public void PlayOneShot(EventReference eventReference)
        {
            RuntimeManager.PlayOneShot(eventReference);
        }

        public void PlayOneShot(EventReference eventReference, Vector3 position)
        {
            RuntimeManager.PlayOneShot(eventReference, position);
        }

        public void PlayOneShot(EventReference eventReference, GameObject emitter)
        {
            RuntimeManager.PlayOneShotAttached(eventReference, emitter);
        }


        public void SetLocalParameter(int eventInstanceID, LocalAudioParameter parameter, float value)
        {
            eventInstances[eventInstanceID].getDescription(out EventDescription eventDescription);
            if (localParameterIDs[eventDescription].TryGetValue(parameter, out PARAMETER_ID parameterID))
            {
                eventInstances[eventInstanceID].setParameterByID(parameterID, value);
            }
            else
            {
                Debug.LogWarning($"Tried to set {parameter} parameter on an event that does not contain it.");
            }
        }


        public float GetLocalParameter(int eventInstanceID, LocalAudioParameter parameter)
        {
            float value = 0;

            eventInstances[eventInstanceID].getDescription(out EventDescription eventDescription);
            if (localParameterIDs[eventDescription].TryGetValue(parameter, out PARAMETER_ID parameterID))
            {
                eventInstances[eventInstanceID].getParameterByID(parameterID, out value);
            }
            else
            {
                Debug.LogWarning($"Tried to get value for {parameter} parameter on an event that does not contain it.");
            }

            return value;
        }


        public void SetGlobalParameter(GlobalAudioParameter parameter, float value)
        {
            RuntimeManager.StudioSystem.setParameterByID(globalParameterIDs[parameter], value);
        }


        public float GetGlobalParameter(GlobalAudioParameter parameter)
        {
            RuntimeManager.StudioSystem.getParameterByID(globalParameterIDs[parameter], out float value);
            return value;
        }
    }
}